<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    Nodejs进阶学习 | Alan的学习曲线
  </title>
  <meta name="description" content="">
  
  <meta name="keywords" content="
  node
  ">
  
  <meta name="author" content="Alan">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="theme-color" content="#1e2327">
  <link rel="apple-touch-icon" href="https://github.githubassets.com/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://github.githubassets.com/apple-touch-icon-180x180.png">

  <link rel="icon" type="image/x-icon" href="https://github.githubassets.com/favicon.ico">
  <link rel="stylesheet" href="/blog/css/main.css">
  <!-- <link rel="stylesheet"
        href="/blog/css/font-awesome.min.css"> -->
  

  

  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script> -->
  <!-- <script src="http://localhost:4000/js/moment.min.js"></script> -->
  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script> -->
  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script> -->
  <script src="/blog/js/vue.min.js"></script>
  <script src="/blog/js/moment.min.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/blog/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">站内搜索</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/blog/archives">Archives</a></li>
        
        
        <li><a href="/blog/categories">Categories</a></li>
        
        
        <li><a href="/blog/tags">Tags</a></li>
        
        
        <!-- <li class="desktop-only"><a href="/blog/atom.xml" target="_blank">RSS</a></li> -->
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="/blog/images/baracktocat.png"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/blog/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/blog/archives"
           class="header-toolbar-right"> 43 </a>
      </li>
      <li>
        <a href="/blog/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/blog/tags"
           class="header-toolbar-right"> 50 </a>
      </li>
      <li>
        <a href="/blog/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/blog/categories"
           class="header-toolbar-right"> 18 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/blog/">Alan的学习曲线</a>
      
      
    </h2>
  </div>

  <!-- <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div> -->
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    Alan

    <span class="post-date float-right" title="{{moment(1657382400000).format('MMM DD, YYYY, h:mm:ss A')}}">
      
          <i class="fa fa-pencil-square-o"></i>
      
      {{moment(1657382400000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>Nodejs进阶学习</h1>
    <h2 id="javascript里程碑事件"><a href="#javascript里程碑事件" class="headerlink" title="javascript里程碑事件"></a>javascript里程碑事件</h2><blockquote>
<p>1995年javascript诞生<br>1997年6月，ECMAScript 1.0<br>1998年6月，ECMAScript 2.0<br>1999年，ActiveX问世，各大厂商实现自己XMLHttpRequest<br>1999年12月，ECMAScript 3.0<br>2005年2月，ajax问世<br>2006年1月，jquery问世<br>2008年12月，谷歌浏览器问世（V8）<br>2009年6月，nodejs问世<br>2009年12月， ECMAScript 5.0<br>2010年，npm问世<br>2015年6月，ECMAScript 6.0<br>2010年，npm问世</p>
</blockquote>
<h2 id="写法规范"><a href="#写法规范" class="headerlink" title="写法规范"></a>写法规范</h2><h3 id="es6规范"><a href="#es6规范" class="headerlink" title="es6规范"></a>es6规范</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// es6规范</span></span><br><span class="line"><span class="keyword">import</span> &#123; add &#125;  <span class="keyword">from</span> <span class="string">&#x27;./tools.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tools.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">export</span> = &#123;</span><br><span class="line">  add</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="commonjs规范"><a href="#commonjs规范" class="headerlink" title="commonjs规范"></a>commonjs规范</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commonjs规范 nodejs(模块缓存)</span></span><br><span class="line"><span class="keyword">const</span> &#123; minus &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./tools.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// tools.js</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">minus</span> = <span class="keyword">function</span>(<span class="params">a, b</span>) &#123;<span class="keyword">return</span> a - b;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="异步解决方案-Promise-或者aysnc-await"><a href="#异步解决方案-Promise-或者aysnc-await" class="headerlink" title="异步解决方案-Promise(或者aysnc&#x2F;await)"></a>异步解决方案-Promise(或者aysnc&#x2F;await)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// reject(&#x27;fail&#x27;);</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">myPromise.<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data); <span class="comment">// resolve的结果 &#x27;success&#x27;</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">result</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result) <span class="comment">// reject的结果 &#x27;fail&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h2><h3 id="浏览器事件循环"><a href="#浏览器事件循环" class="headerlink" title="浏览器事件循环"></a>浏览器事件循环</h3><p>a.JS线程读取并执行JS代码<br>b.执行JS代码的过程中，指定异步的操作给对应的线程处理<br>c.异步线程处理完毕之后，将对应的回调函数推入任务队列（多个）<br>d.JS线程执行完毕之后，查询任务队列，取一个任务推入JS线程运行<br>e: 重复b-d</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>);</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">6</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">7</span>), <span class="number">0</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">8</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">9</span>);</span><br><span class="line"><span class="comment">// 1 9 8 2 3 4 6 5 7 </span></span><br></pre></td></tr></table></figure>
<p>执行流程：</p>
<ol>
<li>查询宏任务队列(把脚本执行当作一个宏任务来看待)，取一个执行</li>
<li>查询微任务队列，全部执行完毕，包括当前微任务队列执行时产生的新的微任务</li>
</ol>
<!-- <img src="../.vuepress/public/images/142.png"> -->
<p><img src="/blog/2022/07/10/2022-07-10-nodejs-beta/142.png" alt="图片"></p>
<h2 id="宏任务队列"><a href="#宏任务队列" class="headerlink" title="宏任务队列"></a>宏任务队列</h2><p>Ajax请求，绑定事件的回调函数，定时器的回调函数…</p>
<h2 id="微任务队列"><a href="#微任务队列" class="headerlink" title="微任务队列"></a>微任务队列</h2><p>promsie, Object.observe, MutationObserver</p>
<h5 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h5><ol>
<li>先执行宏任务（script全局代码）</li>
<li>在执行宏任务的过程中（主进程），<br>  2.1 遇到宏任务（setTimeout&#x2F;setInterval），把该宏任务push到宏任务队列<br>  2.2 遇到微任务（new Promise.then）把该微任务push到微任务队列<br>  2.3 执行完该宏任务后，在执行该宏任务产生的微任务队列</li>
<li>重复执行第二步骤，直至宏任务队列和微任务队列执行完毕，退出javascript脚本执行</li>
</ol>
<h2 id="浏览器的构成"><a href="#浏览器的构成" class="headerlink" title="浏览器的构成"></a>浏览器的构成</h2><!-- <img src="../.vuepress/public/images/143.png"> -->
<p><img src="/blog/2022/07/10/2022-07-10-nodejs-beta/143.png" alt="图片"></p>
<h2 id="nodejs事件循环"><a href="#nodejs事件循环" class="headerlink" title="nodejs事件循环"></a>nodejs事件循环</h2><!-- <img src="../.vuepress/public/images/147.png"> -->
<p><img src="/blog/2022/07/10/2022-07-10-nodejs-beta/147.png" alt="图片"></p>
<p>定时器阶段：setTimeout&#x2F;setInterval<br>等待回调阶段：执行某些系统操作的回调，TCP错误处理<br>闲置阶段、准备阶段：只在内部使用<br>轮询阶段：I&#x2F;O 回调<br>检查阶段：setImmediate<br>关闭回调阶段：关闭类的回调，socket.on(‘close’,…)</p>
<p>ps: 在执行每个阶段任务队列之前，都会清空process.nextTick队列和Promise队列，process.nextTick队列执行优先级更高</p>
<p>在事件循环poll阶段才会把I&#x2F;O回调放到等待回调阶段</p>
<p>timers优先级最高<br>定时器阶段(timers)：</p>
<ol>
<li>执行优先级更高（可以理解为，用户已经等了定时器执行很久了，所以优先执行）</li>
<li>定时器有可能被轮询阶段正在执行的回调阻塞导致延迟（首次轮询不会有阻塞） ps: 用代码模拟一个场景</li>
<li></li>
</ol>
<p>待定回调(pedding callbacks)</p>
<p>idle, prepare: 仅内部系统使用</p>
<p>轮询(poll)<br>检索新的 I&#x2F;O 事件;执行与 I&#x2F;O 相关的回调（几乎所有情况下，除了关闭的回调函数，那些由计时器和 setImmediate() 调度的之外），其余情况 node 将在适当的时候在此阻塞。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1 4 2 3 可以证明先执行timers阶段的回调</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span> <span class="title class_">Node</span>中的事件循环</span><br><span class="line"></span><br><span class="line">定时器阶段：<span class="built_in">setTimeout</span>/<span class="built_in">setInterval</span></span><br><span class="line">等待回调阶段：执行某些系统操作的回调，<span class="variable constant_">TCP</span>错误处理</span><br><span class="line">闲置阶段、准备阶段：只在内部使用</span><br><span class="line">轮询阶段：I/O 回调</span><br><span class="line">检查阶段：setImmediate</span><br><span class="line">关闭回调阶段：关闭类的回调，socket.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>,...)</span><br><span class="line"></span><br><span class="line">注意事项：process.<span class="property">nextTick</span> &gt; promise</span><br><span class="line">每个阶段都有自己的先进先出队列，当事件循环进入到该阶段，就会执行指定的队列，直到队列被耗尽，或者达到回调的最大数量</span><br><span class="line">在进入到每一个阶段之前，都会执行<span class="title class_">NextTick</span>队列和微任务队列，前者优先级更高</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 避免阻塞<span class="title class_">Node</span> =&gt; 高并发(性能)，<span class="variable constant_">DOS</span>攻击(安全)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Node</span>中的线程</span><br><span class="line"><span class="variable constant_">JS</span>引擎的线程：启动阶段，解析模块，注册事件回调，进入事件循环(执行事件回调，非阻塞的异步请求)</span><br><span class="line">libuv的线程池(少量线程)：操作系统不提供非阻塞版本的I/O操作(<span class="variable constant_">DNS</span>)，<span class="variable constant_">CPU</span>密集型的任务</span><br><span class="line"></span><br><span class="line">确保回调函数的时间复杂度为常数</span><br><span class="line"></span><br><span class="line">可能阻塞<span class="title class_">Node</span>的情况</span><br><span class="line">糟糕的正则表达式： (a+)、(a|a)、(a.*)\<span class="number">1</span> =&gt; safe-regex</span><br><span class="line">复杂<span class="title class_">JSON</span>对象的操作 =&gt; <span class="title class_">JSON</span>Stream</span><br><span class="line">复杂计算 =&gt; <span class="title class_">Child</span> <span class="title class_">Process</span>/<span class="title class_">Cluster</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 异步编程方案</span><br><span class="line"></span><br><span class="line">a. 先执行构造函数内的同步代码</span><br><span class="line">b. 支持链式调用，而且then和<span class="keyword">catch</span>返回的是全新的promise对象</span><br><span class="line">c. <span class="keyword">catch</span>只会在异步操作失败或者异常，并且前面流程未定义reject回调函数的时候触发</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// p1</span></span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="comment">// p1</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// p2</span></span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// p3</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span>);</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">6</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">7</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// p4</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">8</span>);</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">9</span>);</span><br><span class="line">    <span class="title function_">resolve</span>();</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">e</span>=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">10</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// p5 </span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">11</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// p6</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">12</span>);</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">13</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">14</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">15</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// p7</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// p8</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">17</span>);</span><br><span class="line">  <span class="title function_">resolve</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">e</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">18</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行过程分析</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">执行结果：</span></span><br><span class="line"><span class="comment">poll阶段：16 17 </span></span><br><span class="line"><span class="comment">清空nextTick队列：1 2 4 </span></span><br><span class="line"><span class="comment">清空promise微任务队列：18 </span></span><br><span class="line"><span class="comment">timers阶段：8 9 </span></span><br><span class="line"><span class="comment">清空promise微任务队列：10</span></span><br><span class="line"><span class="comment">timers阶段：11 </span></span><br><span class="line"><span class="comment">// timers阶段的任务已执行完，poll阶段也没有待执行的任务，开始进入checks阶段, 执行setImmediate的回调，p2的setImmediate会push到checks事件队列队尾</span></span><br><span class="line"><span class="comment">checks阶段: 5  // 执行一个事件对象就要重新轮询到下一个阶段</span></span><br><span class="line"><span class="comment">清空nextTick队列：6</span></span><br><span class="line"><span class="comment">checks阶段: 12</span></span><br><span class="line"><span class="comment">清空nextTick队列：13 14</span></span><br><span class="line"><span class="comment">checks阶段: 3, 7 15 </span></span><br><span class="line"><span class="comment">结论：每个阶段每次执行完一个事件对象就重新开启事件循环</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="nodejs事件循环6个事件"><a href="#nodejs事件循环6个事件" class="headerlink" title="nodejs事件循环6个事件"></a>nodejs事件循环6个事件</h2><!-- <img src="../.vuepress/public/images/145.png"> -->
<p><img src="/blog/2022/07/10/2022-07-10-nodejs-beta/145.png" alt="图片"></p>
<!-- <img src="../.vuepress/public/images/146.png"> -->
<p><img src="/blog/2022/07/10/2022-07-10-nodejs-beta/146.png" alt="图片"></p>
<h2 id="nodejs的构成"><a href="#nodejs的构成" class="headerlink" title="nodejs的构成"></a>nodejs的构成</h2><!-- <img src="../.vuepress/public/images/144.png"> -->
<p><img src="/blog/2022/07/10/2022-07-10-nodejs-beta/144.png" alt="图片"></p>
<h2 id="如何证明nodejs是单线程"><a href="#如何证明nodejs是单线程" class="headerlink" title="如何证明nodejs是单线程"></a>如何证明nodejs是单线程</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">alert</span>(<span class="number">1</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动web服务"><a href="#启动web服务" class="headerlink" title="启动web服务"></a>启动web服务</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Hello World!&#x27;</span>));</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/test&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">sendStatus</span>(<span class="number">200</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;App listening on port 3000!&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="JSON-stringify和JSON-parse执行耗时"><a href="#JSON-stringify和JSON-parse执行耗时" class="headerlink" title="JSON.stringify和JSON.parse执行耗时"></a>JSON.stringify和JSON.parse执行耗时</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: <span class="number">3</span>, <span class="attr">d</span>: <span class="number">4</span>, <span class="attr">e</span>: <span class="number">5</span>, <span class="attr">f</span>: <span class="number">6</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> len = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">var</span> before, res, took, str;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">  obj = &#123; <span class="attr">obj1</span>: obj, <span class="attr">obj2</span>: obj &#125;;</span><br><span class="line">&#125;</span><br><span class="line">before = process.<span class="title function_">hrtime</span>();</span><br><span class="line">str = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj);</span><br><span class="line">took = process.<span class="title function_">hrtime</span>(before);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;JSON.stringify took &#x27;</span> + took); <span class="comment">// 0,252061972</span></span><br><span class="line"></span><br><span class="line">before = process.<span class="title function_">hrtime</span>();</span><br><span class="line">res = str.<span class="title function_">indexOf</span>(<span class="string">&#x27;nomatch&#x27;</span>);</span><br><span class="line">took = process.<span class="title function_">hrtime</span>(before);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Pure indexof took &#x27;</span> + took); <span class="comment">// 0,16016730</span></span><br><span class="line"></span><br><span class="line">before = process.<span class="title function_">hrtime</span>();</span><br><span class="line">res = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(str);</span><br><span class="line">took = process.<span class="title function_">hrtime</span>(before);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;JSON.parse took &#x27;</span> + took);  <span class="comment">// 0,615074412</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="promise"><a href="#promise" class="headerlink" title="promise"></a>promise</h2><p>promise抛出异常或者reject错误，如果promise.then定义了异常处理函数，后面.then会走到成功回调函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flag = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始异步&#x27;</span>);</span><br><span class="line">  <span class="keyword">throw</span> <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">  <span class="comment">// setTimeout(() =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   flag ? resolve(&#x27;成功&#x27;) : reject(&#x27;失败&#x27;);</span></span><br><span class="line">  <span class="comment">// &#125;, 1000);</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p1.<span class="title function_">then</span>(</span><br><span class="line">  <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success1: &#x27;</span>, result);</span><br><span class="line">    <span class="comment">// throw &#x27;报错啦&#x27;;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;成功回调函数的结果&#x27;</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">result</span> =&gt;</span> &#123;  <span class="comment">// 处理异常函数</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fail1: &#x27;</span>, result);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;失败回调函数的结果&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error1:&#x27;</span>, reason);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;异常处理结果&#x27;</span>;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success2: &#x27;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fail2: &#x27;</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error2:&#x27;</span>, reason);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="nextTick循环调用，导致性能问题"><a href="#nextTick循环调用，导致性能问题" class="headerlink" title="nextTick循环调用，导致性能问题"></a>nextTick循环调用，导致性能问题</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nextTick每个阶段执行之前都要先清空nextTick队列</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addNextTickRecurs</span>(<span class="params">count</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> self = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">if</span>(self.<span class="property">id</span> === <span class="literal">undefined</span>) &#123; self.<span class="property">id</span> = <span class="number">0</span>;&#125;</span><br><span class="line">  <span class="keyword">if</span>(self.<span class="property">id</span> === count) <span class="keyword">return</span> ;</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`process.nextTick:<span class="subst">$&#123;++self.id&#125;</span>`</span>)</span><br><span class="line">    addNextTickRecurs.<span class="title function_">call</span>(self, count);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">addNextTickRecurs</span>(<span class="number">1000</span>);  <span class="comment">// 创建1000个Ticks，所以会阻塞事件循环</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="variable language_">console</span>.<span class="property">log</span>.<span class="title function_">bind</span>(<span class="variable language_">console</span>, <span class="string">&#x27;setTimeout&#x27;</span>), <span class="number">10</span>);</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="variable language_">console</span>.<span class="property">log</span>.<span class="title function_">bind</span>(<span class="variable language_">console</span>, <span class="string">&#x27;setImmediate&#x27;</span>));</span><br><span class="line"><span class="comment">// 1 2 ...1000, setTimeout, setImmediate</span></span><br><span class="line"><span class="comment">// 事件循环先从timers阶段开始清空任务队列</span></span><br></pre></td></tr></table></figure>

<h2 id="nodejs循环依赖"><a href="#nodejs循环依赖" class="headerlink" title="nodejs循环依赖"></a>nodejs循环依赖</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a1--&#x27;</span>);</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">finish</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="built_in">require</span>(<span class="string">&#x27;./b&#x27;</span>); <span class="comment">// 加在b模块，会一直把b模块执行完</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a2--&#x27;</span>, b.<span class="property">finish</span>);  <span class="comment">// 这里获取的是b执行完后的结果，所以是true</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">finish</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a3--&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b1--&#x27;</span>);</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">finish</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">&#x27;./a&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b2--&#x27;</span>, a.<span class="property">finish</span>); <span class="comment">// a还没有执行完，所以a.finish获取的是require(&#x27;./b&#x27;) 之前的执行结果，为false</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">finish</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b3--&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;main1--&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">&#x27;./a&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> b = <span class="built_in">require</span>(<span class="string">&#x27;./b&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;main2--&#x27;</span>, a.<span class="property">finish</span>, b.<span class="property">finish</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行命令</span></span><br><span class="line"># node a.<span class="property">js</span>  <span class="comment">// a1, b1, b2--false, b3, a2--true, a3</span></span><br><span class="line"># node main.<span class="property">js</span> <span class="comment">// maint1, a1, b1, b2--false, b3, a2--true, a3, main2--true true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>???</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// process</span></span><br><span class="line"><span class="comment">// Buffer</span></span><br><span class="line"><span class="comment">// stream</span></span><br></pre></td></tr></table></figure>

<h2 id="原生node启动web服务"><a href="#原生node启动web服务" class="headerlink" title="原生node启动web服务"></a>原生node启动web服务</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;req.url--&#x27;</span>, req.<span class="property">url</span>);</span><br><span class="line">  <span class="keyword">const</span> params = querystring.<span class="title function_">parse</span>(req.<span class="property">url</span>.<span class="title function_">split</span>(<span class="string">&#x27;?&#x27;</span>)[<span class="number">1</span>]); <span class="comment">// 获取url中的参数</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;params--&#x27;</span>, params);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(params.<span class="property">name</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> source = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(params.<span class="property">name</span>, <span class="string">&#x27;utf-8&#x27;</span>);  <span class="comment">// 把url参数信息专门放二进制缓冲区,方便转换格式</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;source--&#x27;</span>, source)</span><br><span class="line">    <span class="keyword">let</span> target = source.<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>); <span class="comment">// 转换为16进制数据</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;target--&#x27;</span>, target)</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  res.<span class="property">statusCode</span> = <span class="number">200</span>;</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">const</span> hostname = <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line">server.<span class="title function_">listen</span>(port, hostname, <span class="function">()=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server is up...&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="记录同步-异步错误日志"><a href="#记录同步-异步错误日志" class="headerlink" title="记录同步&#x2F;异步错误日志"></a>记录同步&#x2F;异步错误日志</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Console</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;console&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> output = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;./stdout.log&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> errorOutput = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;./stderr.log&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> logger = <span class="keyword">new</span> <span class="title class_">Console</span>(output, errorOutput);</span><br><span class="line">logger.<span class="title function_">log</span>(<span class="string">&#x27;Alan&#x27;</span>);  <span class="comment">// 写正常日志</span></span><br><span class="line"><span class="comment">// logger.error(&#x27;error&#x27;); // 写错误日志</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 捕获同步任务异常</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fileContents = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./b.txt&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  logger.<span class="title function_">error</span>(error);  <span class="comment">// 写异常日志</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 捕获异步任务异常</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&#x27;./b.txt&#x27;</span>, <span class="function">(<span class="params">err, data</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;data--&#x27;</span>, data);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取文件路径：node ./log/index.js</span></span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;./&#x27;</span>)); <span class="comment">// 执行命令所在目录：/Users/alan/project/nodejs-demo</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(__dirname); <span class="comment">//执行文件所在目录： /Users/alan/project/nodejs-demo/log</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(__filename); <span class="comment">// 执行文件路径： /Users/alan/project/nodejs-demo/log/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听服务是否退出</span></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;exit&#x27;</span>, <span class="function">(<span class="params">code</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`process will close, exit code: <span class="subst">$&#123;code&#125;</span>`</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="commonjs注入模块的变量"><a href="#commonjs注入模块的变量" class="headerlink" title="commonjs注入模块的变量"></a>commonjs注入模块的变量</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module.js</span></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"><span class="built_in">exports</span>, <span class="built_in">require</span>, <span class="variable language_">module</span>, __filename, __dirname</span>) &#123;</span><br><span class="line">  <span class="comment">// commonjs注入以上5个变量到每个模块中</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="执行优先级对比（Promise-setImmediate-process-nextTick-setTimeout）"><a href="#执行优先级对比（Promise-setImmediate-process-nextTick-setTimeout）" class="headerlink" title="执行优先级对比（Promise,setImmediate,process.nextTick,setTimeout）"></a>执行优先级对比（Promise,setImmediate,process.nextTick,setTimeout）</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p1&#x27;</span>));</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p2&#x27;</span>);</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p3&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p4&#x27;</span>);</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;tick1&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p5&#x27;</span>));</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p6&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宏任务里边的宏任务总是会放到下一轮询，微任务立即执行？</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate1&#x27;</span>));</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate2&#x27;</span>);</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;tick2&#x27;</span>));</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;p7&#x27;</span>);</span><br><span class="line">    process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;tick3&#x27;</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate3&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果上面的Promis里面加个Promise试一下</span></span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;tick4&#x27;</span>));</span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;tick5&#x27;</span>);</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;tick6&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;tick7&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout1&#x27;</span>);</span><br><span class="line">  <span class="comment">// 是在执行第一个定时器回调的时候添加到队列的，不是一开始就在队列</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout2&#x27;</span>), <span class="number">0</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate4&#x27;</span>));</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate5&#x27;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行分析</span></span><br><span class="line">promises队列： [p1,p2,p4, p5, p6, p3, p7]</span><br><span class="line">ticks队列：[tick4,tick5, tick7, tick6, tick1, tick2, tick3]</span><br><span class="line">immediate队列： [immediate1,immediate2, immediate4, immediate5, immediate3]</span><br><span class="line">settimeout队列： [timeout1, timeout2]</span><br><span class="line"></span><br><span class="line">tick4, tick5, tick7, tick6</span><br><span class="line">p1, p2, p4, p5 , p6, p3</span><br><span class="line">tick1, </span><br><span class="line">timeout1, </span><br><span class="line">immediate1, immediate2, <span class="comment">// 当前阶段有tick或者promise都要被优先执行</span></span><br><span class="line">tick2, p7 , tick3,  <span class="comment">// 先执行了高优先级任务，tick2添加的任务，要在下一个事件循环阶段才会被执行（immediate3）</span></span><br><span class="line">immediate4, immediate5,  <span class="comment">// 被延后执行是因为先执行了高优先级的任务</span></span><br><span class="line">timeout2</span><br><span class="line">immediate3 <span class="comment">// 第一轮进入immediate队列的任务是「immediate1, immediate2, immediate4, immediate5」，下一个事件循环才会被执行</span></span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line"><span class="number">1.</span> 进入每个事件循环阶段都会优先执行微任务（process.<span class="property">nextTick</span>和<span class="title class_">Promise</span>）</span><br><span class="line"><span class="number">2.</span> 每次执行到某个阶段，会复制已完成任务队列，这就是immediate3为什么会在timeout2后面输出</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="对比timeout和immediate执行时机"><a href="#对比timeout和immediate执行时机" class="headerlink" title="对比timeout和immediate执行时机"></a>对比timeout和immediate执行时机</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 比较 setTimeout 和 setImmediate 在不同情况下的优先级</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不在 I/O 回调内</span></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate&#x27;</span>));</span><br><span class="line"><span class="comment">// 0 =&gt; 1</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timer&#x27;</span>), <span class="number">1000</span>);</span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&#x27;./test.txt&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;readfile&#x27;</span>));</span><br><span class="line"><span class="keyword">while</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() - now &lt; <span class="number">1000</span>) &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<!-- <img src="../.vuepress/public/images/148.png"> -->
<p><img src="/blog/2022/07/10/2022-07-10-nodejs-beta/148.png" alt="图片"></p>
<blockquote>
<p>总结：两种输出结果，主要原因是文件读取时间加while循环条件是否在1000毫秒内，第一次读取文件没有缓存，超过1000毫秒，所以先输出’timer’. 第二次执行fs读取缓存文件，小于1000毫秒，timer阶段还没有成功的回调。所以timer再后面输出。 ps：修改文件名即可看到效果～</p>
</blockquote>
<h2 id="比较setTimeout和setImmediate"><a href="#比较setTimeout和setImmediate" class="headerlink" title="比较setTimeout和setImmediate"></a>比较setTimeout和setImmediate</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 比较 setTimeout 和 setImmediate 在不同情况下的优先级</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"><span class="comment">// 在 I/O 回调内</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&#x27;./test.txt&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;readfile&#x27;</span>);</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timer&#x27;</span>), <span class="number">0</span>);</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line">timer阶段-&gt;i/o阶段-&gt;pedding callback阶段-&gt;poll阶段-&gt;check阶段(setImmediate)-&gt;close callback阶段-&gt;timer阶段</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="commonjs中this指向问题"><a href="#commonjs中this指向问题" class="headerlink" title="commonjs中this指向问题"></a>commonjs中this指向问题</h2><p>模拟module.exports，exports和this初始化阶段指向</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var temp = &#123;&#125;;</span></span><br><span class="line"><span class="comment">// module.exports = temp;</span></span><br><span class="line"><span class="comment">// exports = temp;</span></span><br><span class="line"><span class="comment">// this = temp;</span></span><br></pre></td></tr></table></figure>
<p>案例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> review = <span class="built_in">require</span>(<span class="string">&#x27;./reivew.js&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(review);  <span class="comment">// &#123;count:3&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//# review.js</span></span><br><span class="line"><span class="comment">// var temp = &#123;&#125;;</span></span><br><span class="line"><span class="comment">// module.exports = temp;</span></span><br><span class="line"><span class="comment">// exports = temp;</span></span><br><span class="line"><span class="comment">// this = temp;</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">name</span> = <span class="string">&#x27;Alan&#x27;</span>;  <span class="comment">// 1.temp上面加了name属性, module.exports，exports和this都指向了temp对象</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; <span class="comment">// 2. module.exports指向了新对象&#123;count: 3&#125;，exports和this还指向temp对象</span></span><br><span class="line">  <span class="attr">count</span>: <span class="number">123</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exports</span> = &#123;  <span class="comment">// 3. exports指向了新对象&#123;hello: &#x27;world&#x27;&#125;，this还指向了temp</span></span><br><span class="line">  <span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;this: &#x27;</span>, <span class="variable language_">this</span>);  <span class="comment">// &#123;name: &#x27;Alan&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://www.php.cn/js-tutorial-482450.html">Nodejs进阶学习：深入了解异步I&#x2F;O和事件循环</a><br><a target="_blank" rel="noopener" href="https://qianduan.shop/blogs/detail/17">node事件循环（Event loop）</a></p>

  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://alan89757.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2023 Alan</li>
      <li><a href="https://alan89757.github.io">Home</a></li>
      
      <li><a target="_blank" rel="noopener" href="https://github.com/alan89757">Github</a></li>
      
    </ul>
    <!-- <div class="footer-theme-info">
      Theme <a target="_blank" rel="noopener" href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a target="_blank" rel="noopener" href="//github.com/sabrinaluo">Alan</a> ❤ Powered by Hexo
    </div> -->
    </div>
    
  </footer>
</div>


<script>
  (function() {
    var cx = 'true';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>



<script src="/blog/js/main.js"></script>

</body>
</html>

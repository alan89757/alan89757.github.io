<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    nest入门教程 | Alan的学习曲线
  </title>
  <meta name="description" content="">
  
  <meta name="keywords" content="
  nest,nestjs
  ">
  
  <meta name="author" content="Alan">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="theme-color" content="#1e2327">
  <link rel="apple-touch-icon" href="https://github.githubassets.com/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://github.githubassets.com/apple-touch-icon-180x180.png">

  <link rel="icon" type="image/x-icon" href="https://github.githubassets.com/favicon.ico">
  <link rel="stylesheet" href="/blog/css/main.css">
  <!-- <link rel="stylesheet"
        href="/blog/css/font-awesome.min.css"> -->
  

  

  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script> -->
  <!-- <script src="http://localhost:4000/js/moment.min.js"></script> -->
  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script> -->
  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script> -->
  <script src="/blog/js/vue.min.js"></script>
  <script src="/blog/js/moment.min.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/blog/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">站内搜索</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/blog/archives">Archives</a></li>
        
        
        <li><a href="/blog/categories">Categories</a></li>
        
        
        <li><a href="/blog/tags">Tags</a></li>
        
        
        <!-- <li class="desktop-only"><a href="/blog/atom.xml" target="_blank">RSS</a></li> -->
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="/blog/images/baracktocat.png"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/blog/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/blog/archives"
           class="header-toolbar-right"> 43 </a>
      </li>
      <li>
        <a href="/blog/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/blog/tags"
           class="header-toolbar-right"> 50 </a>
      </li>
      <li>
        <a href="/blog/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/blog/categories"
           class="header-toolbar-right"> 18 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/blog/">Alan的学习曲线</a>
      
      
    </h2>
  </div>

  <!-- <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div> -->
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    Alan

    <span class="post-date float-right" title="{{moment(1654012800000).format('MMM DD, YYYY, h:mm:ss A')}}">
      
          <i class="fa fa-pencil-square-o"></i>
      
      {{moment(1654012800000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>nest入门教程</h1>
    <p>Nest是构建高效，可扩展的 Node.js Web 应用程序的框架</p>
<span id="more"></span>

<h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><h3 id="起步"><a href="#起步" class="headerlink" title="起步"></a>起步</h3><h4 id="安装nestjs"><a href="#安装nestjs" class="headerlink" title="安装nestjs"></a>安装nestjs</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -g @nestjs/cli</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="创建nest项目"><a href="#创建nest项目" class="headerlink" title="创建nest项目"></a>创建nest项目</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nest <span class="keyword">new</span> project-name</span><br></pre></td></tr></table></figure>
<ul>
<li>目录如下：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="property">controller</span>.<span class="property">ts</span> <span class="comment">// 控制器</span></span><br><span class="line">app.<span class="property">module</span>.<span class="property">ts</span>   <span class="comment">// 根模块</span></span><br><span class="line">app.<span class="property">service</span>.<span class="property">ts</span>  <span class="comment">// 服务</span></span><br><span class="line">main.<span class="property">ts</span>   <span class="comment">// 入口文件</span></span><br></pre></td></tr></table></figure></li>
<li>入口文件<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** main.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nest/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure></li>
<li>运行应用程序<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm run start</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="控制器（Controller）"><a href="#控制器（Controller）" class="headerlink" title="控制器（Controller）"></a>控制器（Controller）</h3><h4 id="路由-请求（Request）"><a href="#路由-请求（Request）" class="headerlink" title="路由 + 请求（Request）"></a>路由 + 请求（Request）</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求路径： /api/user-list</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;/api&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsController</span> &#123;</span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;/user-list&#x27;</span>)    <span class="comment">// @Put @Delete @Patch @Options @Head @All</span></span><br><span class="line">  <span class="comment">// @Req 获取所有的请求参数, 包括header头信息</span></span><br><span class="line">  <span class="comment">// @Param 获取查询参数 如：/api/user/123</span></span><br><span class="line">  <span class="comment">// @Body 获取post的请求体</span></span><br><span class="line">  <span class="comment">// @Query 获取url上的查询参数</span></span><br><span class="line">  <span class="title function_">findAll</span>(@<span class="title class_">Req</span>() <span class="attr">request</span>: <span class="title class_">Request</span>): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This action returns all users&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h4><p><code>GET</code><br><code>POST</code><br><code>PUT</code><br><code>DELETE</code><br><code>PATCH</code><br><code>ALL</code><br><code>OPTIONS</code><br><code>HEAD</code></p>
<h4 id="Controller常用装饰器"><a href="#Controller常用装饰器" class="headerlink" title="Controller常用装饰器"></a>Controller常用装饰器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求相关装饰器</span></span><br><span class="line">@<span class="title class_">Request</span> @<span class="title class_">Response</span> @<span class="title class_">Next</span> </span><br><span class="line">@<span class="title class_">Session</span> @<span class="title class_">Param</span> @<span class="title class_">Body</span> </span><br><span class="line">@<span class="title class_">Query</span> @<span class="title class_">Headers</span> @<span class="title class_">Ip</span> @<span class="title class_">HostParam</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">// http方法相应装饰器</span></span><br><span class="line">@<span class="title class_">HttpCode</span> @<span class="title class_">Put</span> @<span class="title class_">Delete</span> @<span class="title class_">Patch</span> @<span class="title class_">Options</span> @<span class="title class_">Head</span> @<span class="title class_">All</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>定义DTO<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CreateCatDto</span> &#123;</span><br><span class="line">  readonly <span class="attr">name</span>: string;</span><br><span class="line">  readonly <span class="attr">age</span>: number;</span><br><span class="line">  readonly <span class="attr">breed</span>: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* cats.controller.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span>, <span class="title class_">Query</span>, <span class="title class_">Post</span>, <span class="title class_">Body</span>, <span class="title class_">Put</span>, <span class="title class_">Param</span>, <span class="title class_">Delete</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateCatDto</span>, <span class="title class_">UpdateCatDto</span>, <span class="title class_">ListAllEntities</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto&#x27;</span>;</span><br><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;cats&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsController</span> &#123;</span><br><span class="line">  @<span class="title class_">Post</span>()</span><br><span class="line">  <span class="title function_">create</span>(<span class="params">@Body() createCatDto: CreateCatDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This action adds a new cat&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  @<span class="title class_">Get</span>()</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params">@Query() query: ListAllEntities</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`This action returns all cats (limit: <span class="subst">$&#123;query.limit&#125;</span> items)`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">findOne</span>(<span class="params">@Param(<span class="string">&#x27;id&#x27;</span>) id: string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`This action returns a #<span class="subst">$&#123;id&#125;</span> cat`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  @<span class="title class_">Put</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">update</span>(<span class="params">@Param(<span class="string">&#x27;id&#x27;</span>) id: string, @Body() updateCatDto: UpdateCatDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`This action updates a #<span class="subst">$&#123;id&#125;</span> cat`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  @<span class="title class_">Delete</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">remove</span>(<span class="params">@Param(<span class="string">&#x27;id&#x27;</span>) id: string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`This action removes a #<span class="subst">$&#123;id&#125;</span> cat`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="类库"><a href="#类库" class="headerlink" title="类库"></a>类库</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* cats.controller.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span>, <span class="title class_">Post</span>, <span class="title class_">Res</span>, <span class="title class_">HttpStatus</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Response</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;cats&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsController</span> &#123;</span><br><span class="line">  @<span class="title class_">Post</span>()</span><br><span class="line">  <span class="title function_">create</span>(<span class="params">@Res() res: Response</span>) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="title class_">HttpStatus</span>.<span class="property">CREATED</span>).<span class="title function_">send</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  @<span class="title class_">Get</span>()</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params">@Res() res: Response</span>) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="title class_">HttpStatus</span>.<span class="property">OK</span>).<span class="title function_">json</span>([]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="提供者（Provider）-Service"><a href="#提供者（Provider）-Service" class="headerlink" title="提供者（Provider）+ Service"></a>提供者（Provider）+ Service</h4><ul>
<li>服务<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Cat</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./interfaces/cat.interface&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@<span class="title class_">Injectable</span>() <span class="comment">// 注入依赖</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsService</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// 实例注入</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private catsService: CatsService</span>) &#123;&#125;</span><br><span class="line">  <span class="comment">// 属性注入</span></span><br><span class="line">  @<span class="title class_">Inject</span>(<span class="string">&#x27;HTTP_OPTIONS&#x27;</span>)</span><br><span class="line">  private readonly <span class="attr">httpClient</span>: T;</span><br><span class="line">  private readonly <span class="attr">cats</span>: <span class="title class_">Cat</span>[] = [];</span><br><span class="line">  <span class="title function_">create</span>(<span class="params">cat: Cat</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cats</span>.<span class="title function_">push</span>(cat);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">findAll</span>(): <span class="title class_">Cat</span>[] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cats</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>可选提供者<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">Optional</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpService</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    @Optional() @Inject(<span class="string">&#x27;HTTP_OPTIONS&#x27;</span>) private readonly httpClient: T</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="模块（Module）"><a href="#模块（Module）" class="headerlink" title="模块（Module）"></a>模块（Module）</h4><p><code>组织应用结构</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_">module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">CatsController</span>],</span><br><span class="line">  <span class="attr">providers</span>:[<span class="title class_">CatsService</span>],</span><br><span class="line">  <span class="attr">imports</span>: [],</span><br><span class="line">  <span class="attr">exports</span>: []</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nest g <span class="variable language_">module</span> cats</span><br><span class="line">$ nest g controller cats</span><br><span class="line">$ nest g service cats</span><br></pre></td></tr></table></figure>

<h4 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Module</span> @<span class="title class_">DynamicModule</span> @<span class="title class_">Controller</span> @<span class="title class_">Service</span> @<span class="title class_">Global</span></span><br></pre></td></tr></table></figure>

<h4 id="动态模块"><a href="#动态模块" class="headerlink" title="动态模块???"></a>动态模块???</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** DatabaseModule.module.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span>, <span class="title class_">DynamicModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateDatabaseProviders</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./database.providers&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Connection</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./connection.provider&#x27;</span>;</span><br><span class="line">@<span class="title class_">Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">Connection</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DatabaseModule</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">forRoot</span>(entities=[], options?): <span class="title class_">DynamicModule</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> providers = <span class="title class_">CreateDatabaseProviders</span>(options, entities);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">module</span>: <span class="title class_">DatabaseModule</span>,</span><br><span class="line">      <span class="attr">providers</span>: providers,</span><br><span class="line">      <span class="attr">exports</span>: providers</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** App.module.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DatabaseModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./database/database.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./users/entities/user.entity&#x27;</span>;</span><br><span class="line">@<span class="title class_">Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">DatabaseModule</span>.<span class="title function_">forRoot</span>([<span class="title class_">User</span>])],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">DatabaseModule</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h4><ul>
<li><p>主要执行以下任务：</p>
<ul>
<li>执行任何代码</li>
<li>对请求和响应对象进行更改</li>
<li>结束请求-响应周期</li>
<li>调用堆栈中的下一个中间件函数</li>
<li>如果当前的中间件函数没有结束请求-响应周期, 它必须调用 next() 将控制传递给下一个中间件函数。否则, 请求将被挂起</li>
<li>可以通过constructor注入依赖</li>
</ul>
</li>
<li><p>定义中间件</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** logger.middleware.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">NestMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span>, <span class="title class_">Response</span>, <span class="title class_">NextFunction</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoggerMiddleware</span> implements <span class="title class_">NestMiddleware</span> &#123;</span><br><span class="line">  <span class="title function_">use</span>(<span class="params">req: Request, res: Response, next: NextFunction</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Request...&#x27;</span>);</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>应用中间件<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** app.module.ts */</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span>, <span class="title class_">NestModule</span>, <span class="title class_">MiddlewareConsumer</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggerMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/middleware/logger.middleware&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CatsModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats/cats.module&#x27;</span>;</span><br><span class="line">@<span class="title class_">Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">CatsModule</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> implements <span class="title class_">NestModule</span> &#123;</span><br><span class="line">  <span class="title function_">configure</span>(<span class="params">consumer: MiddlewareConsumer</span>) &#123;</span><br><span class="line">    consumer</span><br><span class="line">      .<span class="title function_">apply</span>(<span class="title class_">LoggerMiddleware</span>, <span class="title function_">cors</span>(), <span class="title function_">cors1</span>()) <span class="comment">// 应用多个中间件</span></span><br><span class="line">      <span class="comment">// .exclue(</span></span><br><span class="line">      <span class="comment">//   &#123; path: &#x27;cats&#x27;, method: RequestMethod.GET &#125;,</span></span><br><span class="line">      <span class="comment">//   &#123; path: &#x27;cats&#x27;, method: RequestMethod.POST &#125;</span></span><br><span class="line">      <span class="comment">// )</span></span><br><span class="line">      .<span class="title function_">forRoutes</span>(&#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;cats&#x27;</span>,</span><br><span class="line">        <span class="attr">method</span>: <span class="title class_">RequestMethod</span>.<span class="property">GET</span></span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>全局中间件<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">app.<span class="title function_">use</span>(logger);</span><br><span class="line"><span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>); </span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="异常过滤器"><a href="#异常过滤器" class="headerlink" title="异常过滤器"></a>异常过滤器</h4><ul>
<li><p>基础异常类</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** cats.controller.ts */</span></span><br><span class="line">@<span class="title class_">Get</span>()</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// HttpException第一个参数支持字符串和对象</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpException</span>(<span class="string">&#x27;Forbidden&#x27;</span>, <span class="title class_">HttpCode</span>.<span class="property">FORBIDDEN</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title class_">Get</span>()</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">findAll2</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpException</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="title class_">HttpCode</span>.<span class="property">FORBIDDEN</span>,</span><br><span class="line">    <span class="attr">error</span>: <span class="string">&#x27;This is a custom message&#x27;</span>,</span><br><span class="line">  &#125;, <span class="title class_">HttpStatus</span>.<span class="property">FORBIDDEN</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义异常</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** forbidden.exception.ts */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ForbiddenException</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HttpException</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(<span class="string">&#x27;Forbidden&#x27;</span>, <span class="title class_">HttpStatus</span>.<span class="property">FORBIDDEN</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** 使用自定义异常 */</span></span><br><span class="line">@<span class="title class_">Get</span>()</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ForbiddenException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>内置异常<br><code>BadRequestException</code><br><code>UnauthorizedException</code><br><code>NotFoundException</code><br><code>ForbiddenException</code><br><code>NotAcceptableException</code><br><code>RequestTimeoutException</code><br><code>ConflictException</code><br><code>GoneException</code><br><code>PayloadTooLargeException</code><br><code>UnsupportedMediaTypeException</code><br><code>UnprocessableException</code><br><code>InternalServerErrorException</code><br><code>NotImplementedException</code><br><code>BadGatewayException</code><br><code>ServiceUnavailableException</code><br><code>GatewayTimeoutException</code></p>
</li>
<li><p>异常过滤器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ExceptionFilter</span>, <span class="title class_">Catch</span>, <span class="title class_">ArgumentsHost</span>, <span class="title class_">HttpException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span>, <span class="title class_">Response</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line">@<span class="title class_">Catch</span>(<span class="title class_">HttpException</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpExceptionFilter</span> implements <span class="title class_">ExceptionFilter</span> &#123;</span><br><span class="line">  <span class="keyword">catch</span>(<span class="attr">exception</span>: <span class="title class_">HttpException</span>, <span class="attr">host</span>: <span class="title class_">ArgumentsHost</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = host.<span class="title function_">switchToHttp</span>();</span><br><span class="line">    <span class="keyword">const</span> response = ctx.<span class="property">getResponse</span>&lt;<span class="title class_">Response</span>&gt;();</span><br><span class="line">    <span class="keyword">const</span> request = ctx.<span class="property">getRequest</span>&lt;<span class="title class_">Request</span>&gt;();</span><br><span class="line">    <span class="keyword">const</span> status = exception.<span class="title function_">getStatus</span>();</span><br><span class="line">    response</span><br><span class="line">      .<span class="title function_">status</span>(status)</span><br><span class="line">      .<span class="title function_">json</span>(&#123;</span><br><span class="line">        <span class="attr">statusCode</span>: status,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">        <span class="attr">path</span>: request.<span class="property">url</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>绑定过滤器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Post</span>()</span><br><span class="line">@<span class="title class_">UseFilters</span>(<span class="keyword">new</span> <span class="title class_">HttpExceptionFilter</span>())</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">@Body() createCatDto: CreateCatDto</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ForbiddenException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>全局过滤器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">APP_FILTER</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line">@<span class="title class_">Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="variable constant_">APP_FILTER</span>,</span><br><span class="line">      <span class="attr">useClass</span>: <span class="title class_">HttpExceptionFilter</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">ExceptionFilter</span>,</span><br><span class="line">  <span class="title class_">Catch</span>,</span><br><span class="line">  <span class="title class_">ArgumentsHost</span>,</span><br><span class="line">  <span class="title class_">HttpException</span>,</span><br><span class="line">  <span class="title class_">HttpStatus</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line">@<span class="title class_">Catch</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AllExceptionsFilter</span> implements <span class="title class_">ExceptionFilter</span> &#123;</span><br><span class="line">  <span class="keyword">catch</span>(<span class="attr">exception</span>: unknown, <span class="attr">host</span>: <span class="title class_">ArgumentsHost</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = host.<span class="title function_">switchToHttp</span>();</span><br><span class="line">    <span class="keyword">const</span> response = ctx.<span class="title function_">getResponse</span>();</span><br><span class="line">    <span class="keyword">const</span> request = ctx.<span class="title function_">getRequest</span>();</span><br><span class="line">    <span class="keyword">const</span> status =</span><br><span class="line">      exception <span class="keyword">instanceof</span> <span class="title class_">HttpException</span></span><br><span class="line">        ? exception.<span class="title function_">getStatus</span>()</span><br><span class="line">        : <span class="title class_">HttpStatus</span>.<span class="property">INTERNAL_SERVER_ERROR</span>;</span><br><span class="line">    response.<span class="title function_">status</span>(status).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">statusCode</span>: status,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">      <span class="attr">path</span>: request.<span class="property">url</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><p>管道主要有两个类型：<br>转换：管道将输入数据转换为所需的数据输出<br>验证：对输入数据进行验证，如果验证成功继续传递; 验证失败则抛出异常;</p>
<ul>
<li><p>内置管道<br><code>ValidationPipe</code><br><code>ParseIntPipe</code><br><code>ParseBoolPipe</code><br><code>ParseArrayPipe</code><br><code>ParseUUIDPipe</code><br><code>DefaultValuePipe</code></p>
</li>
<li><p>自定义管道</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PipeTransform</span>, <span class="title class_">Injectable</span>, <span class="title class_">ArgumentMetadata</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ValidationPipe</span> implements <span class="title class_">PipeTransform</span> &#123;</span><br><span class="line">  <span class="title function_">transform</span>(<span class="params">value: any, metadata: ArgumentMetadata</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>对象结构验证</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save @hapi/joi</span><br><span class="line">$ npm install --save-dev @types/hapi__joi</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证管道</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PipeTransform</span>, <span class="title class_">Injectable</span>, <span class="title class_">ArgumentMetadata</span>, <span class="title class_">BadRequestException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ObjectSchema</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@hapi/joi&#x27;</span>;</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JoiValidationPipe</span> implements <span class="title class_">PipeTransform</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private schema: ObjectSchema</span>) &#123;&#125;</span><br><span class="line">  <span class="title function_">transform</span>(<span class="params">value: any, metadata: ArgumentMetadata</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; error &#125; = <span class="variable language_">this</span>.<span class="property">schema</span>.<span class="title function_">validate</span>(value);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&#x27;Validation failed&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>绑定管道</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Post</span>()</span><br><span class="line">@<span class="title class_">UsePipes</span>(<span class="keyword">new</span> <span class="title class_">JoiValidationPipe</span>(createCatSchema))</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">@Body() createCatDto: CreateCatDto</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">catsService</span>.<span class="title function_">create</span>(createCatDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>类验证器<br><code>npm i --save class-validator class-transformer</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IsString</span>, <span class="title class_">IsInt</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;class-validator&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CreateCatDto</span> &#123;</span><br><span class="line">  @<span class="title class_">IsString</span>()</span><br><span class="line">  <span class="attr">name</span>: string;</span><br><span class="line">  @<span class="title class_">IsInt</span>()</span><br><span class="line">  <span class="attr">age</span>: number;</span><br><span class="line">  @<span class="title class_">IsString</span>()</span><br><span class="line">  <span class="attr">breed</span>: string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="类验证器"><a href="#类验证器" class="headerlink" title="类验证器"></a>类验证器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PipeTransform</span>, <span class="title class_">Injectable</span>, <span class="title class_">ArgumentMetadata</span>, <span class="title class_">BadRequestException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; validate &#125; <span class="keyword">from</span> <span class="string">&#x27;class-validator&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; plainToClass &#125; <span class="keyword">from</span> <span class="string">&#x27;class-transformer&#x27;</span>;</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ValidationPipe</span> implements <span class="title class_">PipeTransform</span>&lt;any&gt; &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">transform</span>(<span class="params">value: any, &#123; metatype &#125;: ArgumentMetadata</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!metatype || !<span class="variable language_">this</span>.<span class="title function_">toValidate</span>(metatype)) &#123;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> object = <span class="title function_">plainToClass</span>(metatype, value);</span><br><span class="line">    <span class="keyword">const</span> errors = <span class="keyword">await</span> <span class="title function_">validate</span>(object);</span><br><span class="line">    <span class="keyword">if</span> (errors.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&#x27;Validation failed&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">  private <span class="title function_">toValidate</span>(<span class="attr">metatype</span>: <span class="title class_">Function</span>): boolean &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">types</span>: <span class="title class_">Function</span>[] = [<span class="title class_">String</span>, <span class="title class_">Boolean</span>, <span class="title class_">Number</span>, <span class="title class_">Array</span>, <span class="title class_">Object</span>];</span><br><span class="line">    <span class="keyword">return</span> !types.<span class="title function_">includes</span>(metatype);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>全局管道</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">APP_PIPE</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line">@<span class="title class_">Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="variable constant_">APP_PIPE</span>,</span><br><span class="line">      <span class="attr">useClass</span>: <span class="title class_">ValidationPipe</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>转换管道</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PipeTransform</span>, <span class="title class_">Injectable</span>, <span class="title class_">ArgumentMetadata</span>, <span class="title class_">BadRequestException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ParseIntPipe</span> implements <span class="title class_">PipeTransform</span>&lt;string, number&gt; &#123;</span><br><span class="line">  <span class="title function_">transform</span>(<span class="attr">value</span>: string, <span class="attr">metadata</span>: <span class="title class_">ArgumentMetadata</span>): number &#123;</span><br><span class="line">    <span class="keyword">const</span> val = <span class="built_in">parseInt</span>(value, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNaN</span>(val)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&#x27;Validation failed&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="守卫"><a href="#守卫" class="headerlink" title="守卫"></a>守卫</h4><p>├── 授权守卫<br>├── 基于角色认证<br>├── 绑定守卫</p>
<h4 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h4><p>├── 绑定拦截器<br>├── 响应映射<br>├── 异常映射</p>
<h3 id="nest流程图"><a href="#nest流程图" class="headerlink" title="nest流程图"></a>nest流程图</h3><!-- <img src="../.vuepress/public/images/131.png"> -->
<p><img src="/blog/2022/06/01/2022-06-01-nest/131.png" alt="图片"></p>
<h3 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h3><h4 id="配置请求路由（Get-Post）"><a href="#配置请求路由（Get-Post）" class="headerlink" title="配置请求路由（Get&#x2F;Post）"></a>配置请求路由（Get&#x2F;Post）</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="comment">// get请求</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;/list&#x27;</span>)</span><br><span class="line">  <span class="title function_">list</span>(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;我是get请求&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// post请求</span></span><br><span class="line">  @<span class="title class_">Post</span>(<span class="string">&#x27;/create&#x27;</span>)</span><br><span class="line">  <span class="title function_">create</span>(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;我是post请求&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="vscode调试node"><a href="#vscode调试node" class="headerlink" title="vscode调试node"></a>vscode调试node</h3><p><strong>（1）配置路径： 运行&#x3D;&gt;添加配置</strong></p>
<!-- <img src="../.vuepress/public/images/132.png"> -->
<p><img src="/blog/2022/06/01/2022-06-01-nest/132.png" alt="图片"><br><strong>(2) 选择‘nodejs’</strong></p>
<!-- <img src="../.vuepress/public/images/133.png"> -->
<p><img src="/blog/2022/06/01/2022-06-01-nest/133.png" alt="图片"><br><strong>(3) 调试成功</strong></p>
<!-- <img src="../.vuepress/public/images/134.png"> -->
<p><img src="/blog/2022/06/01/2022-06-01-nest/134.png" alt="图片"></p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="（1）配置路径：-运行-添加配置"><a href="#（1）配置路径：-运行-添加配置" class="headerlink" title="（1）配置路径： 运行&#x3D;&gt;添加配置"></a>（1）配置路径： 运行&#x3D;&gt;添加配置</h4><!-- <img src="./1.png"> -->

<h4 id="2-选择‘nodejs’"><a href="#2-选择‘nodejs’" class="headerlink" title="(2) 选择‘nodejs’"></a>(2) 选择‘nodejs’</h4><!-- <img src="./2.png"> -->

<h4 id="3-调试成功"><a href="#3-调试成功" class="headerlink" title="(3) 调试成功"></a>(3) 调试成功</h4><!-- <img src="./3.png"> -->


<h4 id="获取请求参数"><a href="#获取请求参数" class="headerlink" title="获取请求参数"></a>获取请求参数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="comment">// 获取所有的参数</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;/all&#x27;</span>)</span><br><span class="line">  <span class="title function_">all</span>(@<span class="title class_">Req</span>() <span class="attr">req</span>: <span class="title class_">Request</span>): string &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello all&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取动态参数</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;/param/:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">getParams</span>(@<span class="title class_">Param</span>(<span class="string">&#x27;id&#x27;</span>) <span class="attr">id</span>: number): string &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`获得参数id为<span class="subst">$&#123;id&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取请求体body</span></span><br><span class="line">  @<span class="title class_">Post</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">  <span class="title function_">getBody</span>(@<span class="title class_">Body</span>() <span class="attr">req</span>: object): object &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req);</span><br><span class="line">    <span class="keyword">return</span> req;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取url查询参数</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;query&#x27;</span>)</span><br><span class="line">  <span class="title function_">getQuery</span>(@<span class="title class_">Query</span>(<span class="string">&#x27;name&#x27;</span>) <span class="attr">name</span>: string): string &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`获得参数name为<span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取请求头信息</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;header&#x27;</span>)</span><br><span class="line">  <span class="title function_">getHeader</span>(@<span class="title class_">Headers</span>() <span class="attr">req</span>: object): object &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req);</span><br><span class="line">    <span class="keyword">return</span> req;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设置响应数据"><a href="#设置响应数据" class="headerlink" title="设置响应数据"></a>设置响应数据</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="comment">// 设置状态码</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;/httpCode&#x27;</span>)</span><br><span class="line">  @<span class="title class_">HttpCode</span>(<span class="number">304</span>)</span><br><span class="line">  <span class="title function_">getHttpCode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello getHttpCode&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置header头</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;/header&#x27;</span>)</span><br><span class="line">  @<span class="title class_">Header</span>(<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;xxx&#x27;</span>)</span><br><span class="line">  <span class="title function_">getHeaders</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello getHeaders&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重定向</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;/redirect&#x27;</span>)</span><br><span class="line">  @<span class="title class_">Redirect</span>(<span class="string">&#x27;https://nestjs.com&#x27;</span>, <span class="number">301</span>)</span><br><span class="line">  <span class="title function_">getRedirect</span>(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello getRedirect&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用服务方法"><a href="#调用服务方法" class="headerlink" title="调用服务方法"></a>调用服务方法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">--------------------app.<span class="property">controller</span>.<span class="property">ts</span>----------------------</span><br><span class="line"></span><br><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private readonly appservice: AppService</span>) &#123;&#125;</span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  <span class="title function_">getHello</span>(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">appservice</span>.<span class="title function_">getHello</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------------------app.<span class="property">service</span>.<span class="property">ts</span>-------------------------</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppService</span> &#123;</span><br><span class="line">  <span class="title function_">getHello</span>(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="共享模块-sharedModule"><a href="#共享模块-sharedModule" class="headerlink" title="共享模块(sharedModule)"></a>共享模块(sharedModule)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">--------------------cats.<span class="property">module</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">CatsController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">CatsService</span>],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">CatsService</span>], <span class="comment">// 在引入CatsModule时不需要显式注册服务</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CatsModule</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">--------------------app.<span class="property">module</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">CatsModule</span>],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AppService</span>],  <span class="comment">// 不需要显式指定CatsService</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">--------------------app.<span class="property">controller</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private readonly catsService: CatsService</span>) &#123;&#125; <span class="comment">// 注入依赖</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  <span class="title function_">getHello</span>(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">catsService</span>.<span class="title function_">getCats</span>(); <span class="comment">// 能直接调用catsService的方法</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------common.<span class="property">module</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Global</span>() <span class="comment">// 全局模块</span></span><br><span class="line">@<span class="title class_">Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">CommonService</span>],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">CommonController</span>],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">CommonService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CommonModule</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="中间件-midddleware"><a href="#中间件-midddleware" class="headerlink" title="中间件(midddleware)"></a>中间件(midddleware)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">--------------------logger.<span class="property">middleware</span>.<span class="property">ts</span>-----------------</span><br><span class="line"><span class="comment">// 函数中间件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">LoggerMiddleware</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Global Logger Request...`</span>);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// class中间件</span></span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Logger1Middleware</span> implements <span class="title class_">NestMiddleware</span> &#123;</span><br><span class="line">  <span class="title function_">use</span>(<span class="params">req: Request, res: Response, next: NextFunction</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Logger1 Request...&#x27;</span>);</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------main.<span class="property">ts</span>----------------------</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  app.<span class="title function_">use</span>(<span class="title class_">LoggerMiddleware</span>);  <span class="comment">// 注册全局中间件</span></span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br><span class="line"></span><br><span class="line">--------------------app.<span class="property">module</span>.<span class="property">ts</span>-----------------</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> implements <span class="title class_">NestModule</span> &#123;</span><br><span class="line">  <span class="title function_">configure</span>(<span class="params">consumer: MiddlewareConsumer</span>) &#123;</span><br><span class="line">    <span class="comment">// 应用多个中间件</span></span><br><span class="line">    consumer</span><br><span class="line">      .<span class="title function_">apply</span>(<span class="title class_">Logger1Middleware</span>, <span class="title class_">Logger2Middleware</span>, <span class="title class_">Logger3Middleware</span>)</span><br><span class="line">      .<span class="title function_">forRoutes</span>(<span class="string">&#x27;/cats/global-fn-middleware&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">--------------------app.<span class="property">controller</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Controller</span>(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private readonly catsService: CatsService</span>) &#123;&#125;</span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;custom-forbidden&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">customForbindden</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// throw new HttpException(&#x27;Forbidden111&#x27;, HttpStatus.FORBIDDEN);  // nest内置异常</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ForbiddenException</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------forbidden.<span class="property">exception</span>.<span class="property">ts</span>-----------------</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ForbiddenException</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HttpException</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(<span class="string">&#x27;custom Forbidden&#x27;</span>, <span class="title class_">HttpStatus</span>.<span class="property">FORBIDDEN</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------main.<span class="property">ts</span>-----------------</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  app.<span class="title function_">use</span>(<span class="title class_">LoggerMiddleware</span>);</span><br><span class="line">  <span class="comment">// app.useGlobalFilters(new HttpExceptionFilter()); // 注册全局异常</span></span><br><span class="line">  app.<span class="title function_">useGlobalFilters</span>(<span class="keyword">new</span> <span class="title class_">AllExceptionsFilter</span>());  <span class="comment">// 注册全局异常</span></span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br><span class="line"></span><br><span class="line">--------------------any-exception.<span class="property">filter</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Catch</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AllExceptionsFilter</span> implements <span class="title class_">ExceptionFilter</span> &#123;</span><br><span class="line">  <span class="keyword">catch</span>(<span class="attr">exception</span>: unknown, <span class="attr">host</span>: <span class="title class_">ArgumentsHost</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = host.<span class="title function_">switchToHttp</span>();</span><br><span class="line">    <span class="keyword">const</span> response = ctx.<span class="title function_">getResponse</span>();</span><br><span class="line">    <span class="keyword">const</span> request = ctx.<span class="title function_">getRequest</span>();</span><br><span class="line">    <span class="comment">// 指定处理某类一样</span></span><br><span class="line">    <span class="keyword">const</span> status =</span><br><span class="line">      exception <span class="keyword">instanceof</span> <span class="title class_">HttpException</span></span><br><span class="line">        ? exception.<span class="title function_">getStatus</span>()</span><br><span class="line">        : <span class="title class_">HttpStatus</span>.<span class="property">INTERNAL_SERVER_ERROR</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;AllExceptionsFilter&#x27;</span>);</span><br><span class="line">    response.<span class="title function_">status</span>(status).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">statusCode</span>: status,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>(),</span><br><span class="line">      <span class="attr">path</span>: request.<span class="property">url</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="管道-pipe"><a href="#管道-pipe" class="headerlink" title="管道(pipe)"></a>管道(pipe)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">--------------------any-exception.<span class="property">filter</span>.<span class="property">ts</span>-----------------</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Joi</span> = <span class="built_in">require</span>(<span class="string">&#x27;joi&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> schema = <span class="title class_">Joi</span>.<span class="title function_">object</span>(&#123;</span><br><span class="line">  <span class="attr">username</span>: <span class="title class_">Joi</span>.<span class="title function_">string</span>()</span><br><span class="line">      .<span class="title function_">min</span>(<span class="number">3</span>)</span><br><span class="line">      .<span class="title function_">max</span>(<span class="number">16</span>)</span><br><span class="line">      .required(),</span><br><span class="line">  <span class="attr">password</span>: <span class="title class_">Joi</span>.<span class="title function_">string</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">@<span class="title class_">Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private readonly catsService: CatsService</span>) &#123; &#125;</span><br><span class="line">  <span class="comment">// 自定义管道</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;pipe/:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">findOne</span>(</span><br><span class="line">    @<span class="title class_">Param</span>(<span class="string">&#x27;id&#x27;</span>, <span class="keyword">new</span> <span class="title class_">ParseIntPipe</span>()) <span class="comment">// 验证是否数字</span></span><br><span class="line">    <span class="attr">id</span>: number,</span><br><span class="line">  ): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`get id <span class="subst">$&#123;id&#125;</span> `</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 对象验证（joi） https://joi.dev/api/?v=17.6.0</span></span><br><span class="line">  @<span class="title class_">Post</span>(<span class="string">&#x27;create&#x27;</span>)</span><br><span class="line">  @<span class="title class_">UsePipes</span>(<span class="keyword">new</span> <span class="title class_">JoiValidationPipe</span>(schema))  <span class="comment">// 对象验证</span></span><br><span class="line">  <span class="title function_">create</span>(<span class="params">@Body() Body</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;表单创建成功!&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------parse-int.<span class="property">pipe</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ParseIntPipe</span> implements <span class="title class_">PipeTransform</span>&lt;string&gt; &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">transform</span>(<span class="params">value: string, metadata: ArgumentMetadata</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> val = <span class="built_in">parseInt</span>(value, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNaN</span>(val)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&#x27;无效的值&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------joi.<span class="property">validation</span>.<span class="property">pipe</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JoiValidationPipe</span> implements <span class="title class_">PipeTransform</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private schema: Schema</span>) &#123;&#125;</span><br><span class="line">  <span class="title function_">transform</span>(<span class="params">value: any, metadata: ArgumentMetadata</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JoiValidationPipe&quot;</span>, value)</span><br><span class="line">    <span class="keyword">const</span> &#123; error &#125; = <span class="variable language_">this</span>.<span class="property">schema</span>.<span class="title function_">validate</span>(value);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&#x27;表单数据填写有误，请重新提交&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="守卫-guard"><a href="#守卫-guard" class="headerlink" title="守卫(guard)"></a>守卫(guard)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">--------------------app.<span class="property">controller</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">UseGuards</span>(<span class="title class_">RolesGuard</span>)    <span class="comment">// 注册守卫</span></span><br><span class="line"><span class="comment">// @UseInterceptors(Logging1Interceptor)</span></span><br><span class="line">@<span class="title class_">Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private readonly catsService: CatsService</span>) &#123;&#125;</span><br><span class="line">  <span class="comment">// 守卫</span></span><br><span class="line">  @<span class="title class_">Post</span>(<span class="string">&#x27;/guards/create&#x27;</span>)</span><br><span class="line">  <span class="title function_">guards</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;get guards&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------roles.<span class="property">guard</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">RolesGuard</span> implements <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="title function_">canActivate</span>(</span><br><span class="line">    <span class="attr">context</span>: <span class="title class_">ExecutionContext</span>,</span><br><span class="line">  ): boolean | <span class="title class_">Promise</span>&lt;boolean&gt; | <span class="title class_">Observable</span>&lt;boolean&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = context.<span class="title function_">switchToHttp</span>().<span class="title function_">getRequest</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;RolesGuard_&#x27;</span>, request.<span class="property">body</span>);</span><br><span class="line">    <span class="comment">// validateForm(request.body);  // 验证表单内容</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="拦截器-interceptor"><a href="#拦截器-interceptor" class="headerlink" title="拦截器(interceptor)"></a>拦截器(interceptor)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">--------------------app.<span class="property">controller</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">UseInterceptors</span>(<span class="title class_">Logging1Interceptor</span>)  <span class="comment">// 注册拦截器到控制器</span></span><br><span class="line">@<span class="title class_">Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">private readonly catsService: CatsService</span>) &#123;&#125;</span><br><span class="line">  <span class="comment">// 拦截器-异常映射</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;interceptor-exception&#x27;</span>)</span><br><span class="line">  @<span class="title class_">UseInterceptors</span>(<span class="keyword">new</span> <span class="title class_">ErrorsInterceptor</span>()) <span class="comment">// 注册拦截器到方法</span></span><br><span class="line">  <span class="title function_">exception</span>(): string &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpException</span>(<span class="string">&#x27;Forbidden&#x27;</span>, <span class="title class_">HttpStatus</span>.<span class="property">FORBIDDEN</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;get interceptor-exception&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拦截器-响应映射</span></span><br><span class="line">  @<span class="title class_">Post</span>(<span class="string">&#x27;interceptor-response&#x27;</span>)</span><br><span class="line">  @<span class="title class_">UseInterceptors</span>(<span class="keyword">new</span> <span class="title class_">TransformInterceptor</span>()) <span class="comment">// 注册拦截器到方法</span></span><br><span class="line">  <span class="title function_">response</span>(): object &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">errCode</span>: -<span class="number">10000</span>,</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&#x27;购买失败&#x27;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 绑定拦截器-三种方式</span></span><br><span class="line">  @<span class="title class_">Get</span>(<span class="string">&#x27;interceptor&#x27;</span>)</span><br><span class="line">  <span class="title function_">getInterceptor</span>(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;get Interceptor&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------logging1.<span class="property">interceptor</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Logging1Interceptor</span> implements <span class="title class_">NestInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>, <span class="attr">next</span>: <span class="title class_">CallHandler</span>): <span class="title class_">Observable</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Before Logging-1-Interceptor...&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">      .<span class="title function_">handle</span>()</span><br><span class="line">      .<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title function_">tap</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`After Logging-1-Interceptor... <span class="subst">$&#123;<span class="built_in">Date</span>.now() - now&#125;</span>ms`</span>)),</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------exception.<span class="property">interceptor</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ErrorsInterceptor</span> implements <span class="title class_">NestInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>, <span class="attr">next</span>: <span class="title class_">CallHandler</span>): <span class="title class_">Observable</span>&lt;any&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ErrorsInterceptor__&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">      .<span class="title function_">handle</span>()</span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">catchError</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="title function_">throwError</span>(<span class="keyword">new</span> <span class="title class_">BadGatewayException</span>())));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------transform.<span class="property">interceptor</span>.<span class="property">ts</span>-----------------</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TransformInterceptor</span>&lt;T&gt;</span><br><span class="line">  implements <span class="title class_">NestInterceptor</span>&lt;T, <span class="title class_">Response</span>&lt;T&gt;&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="title function_">intercept</span>(</span><br><span class="line">    <span class="attr">context</span>: <span class="title class_">ExecutionContext</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="title class_">CallHandler</span>,</span><br><span class="line">  ): <span class="title class_">Observable</span>&lt;<span class="title class_">Response</span>&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;TransformInterceptor&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>().<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">        <span class="keyword">typeof</span> data === <span class="string">&#x27;object&#x27;</span> ? (data[<span class="string">&#x27;detail&#x27;</span>] = <span class="string">&#x27;库存不足&#x27;</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  <span class="comment">// 注册全局中间件</span></span><br><span class="line">  <span class="comment">// app.use(LoggerMiddleware);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册全局异常</span></span><br><span class="line">  <span class="comment">// app.useGlobalFilters(new HttpExceptionFilter());</span></span><br><span class="line">  <span class="comment">// app.useGlobalFilters(new AllExceptionsFilter());</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册全局守卫</span></span><br><span class="line">  <span class="comment">// app.useGlobalGuards(new AuthGlobalGuard());</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册全局拦截器</span></span><br><span class="line">  <span class="comment">// app.useGlobalInterceptors(new Logging2Interceptor())</span></span><br><span class="line">  app.<span class="title function_">useGlobalInterceptors</span>(<span class="keyword">new</span> <span class="title class_">TransformInterceptor</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="nestjs核心模块"><a href="#nestjs核心模块" class="headerlink" title="nestjs核心模块"></a>nestjs核心模块</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://alan89757.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2023 Alan</li>
      <li><a href="https://alan89757.github.io">Home</a></li>
      
      <li><a target="_blank" rel="noopener" href="https://github.com/alan89757">Github</a></li>
      
    </ul>
    <!-- <div class="footer-theme-info">
      Theme <a target="_blank" rel="noopener" href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a target="_blank" rel="noopener" href="//github.com/sabrinaluo">Alan</a> ❤ Powered by Hexo
    </div> -->
    </div>
    
  </footer>
</div>


<script>
  (function() {
    var cx = 'true';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>



<script src="/blog/js/main.js"></script>

</body>
</html>
